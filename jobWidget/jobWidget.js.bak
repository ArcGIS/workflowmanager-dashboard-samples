/**
 * Created by kevi6083 on 2/16/2016.
 */

define([
    "dojo/_base/declare",
    "dojo/_base/lang",
    "dijit/_WidgetBase",
    "dijit/_TemplatedMixin",
    "esri/opsdashboard/WidgetProxy",
    "esri/tasks/query",
    "workflowmanager/WMJobTask",
    "workflowmanager/WMWorkflowTask",
    "dojo/text!./JobWidgetTemplate.html"
], function (declare, lang, _WidgetBase, _TemplatedMixin, WidgetProxy, Query, WMJobTask, WMWorkflowTask, templateString) {
    "use strict";
    return declare("JobWidget", [_WidgetBase, _TemplatedMixin, WidgetProxy], {
        templateString: templateString,
        debugName: "JobWidget",
        currentJob: null,
        jobTask: null,
        workflowTask: null,
        defaultJobName: "No Jobs Selected",

        hostReady: function () {
            this.serverUrl = "http://kevinb:6080/arcgis/rest/services/advanced/WMServer";
            this.jobTask = new WMJobTask(this.serverUrl);
            this.workflowTask = new WMWorkflowTask(this.serverUrl);

            this.jobName.innerHTML = this.defaultJobName;
        },
        dataSourceExpired: function (dataSource, dataSourceConfig) {

            // Execute the query. A request will be sent to the server
            // to query for the features.
            // The results are in the featureSet
            dataSource.executeQuery(new Query()).then(lang.hitch(this, function (featureSet) {

                if (featureSet.features) {
                    var feature = featureSet.features[0];
                    var jobId = feature.attributes["sde.jtx2.JTX_JOBS_AOI.job_id"];

                    if (this.currentJob === jobId) {
                        return;
                    }

                    this.currentJob = jobId;
                    console.info("Retrieving job " + jobId);

                    this.jobTask.getJob(jobId, function (data) {
                        this.jobName.innerHTML = data.name;
                    }.bind(this));

                    this.loadWorkflow();
                } else {
                    this.currentJob = null;
                    this.jobName.innerHTML = this.defaultJobName;
                    $("#workflowImg").remove();
                }
            }));
        },

        loadWorkflow: function () {
            var self = lang.hitch(this);
            //dom.byId("executeStep").disabled = true;
            //dom.byId("markAsComplete").disabled = true;

            // get workflow image using WorkflowTask

            var jobId = self.currentJob;
            var imageUrl = self.workflowTask.getWorkflowImageURL(jobId);

            // if workflow image already exists, refresh it
            if ($("#workflowImg").length) {
                // reload image
                $("#workflowImg").attr("src", imageUrl + "?timestamp=" + new Date().getTime());
            } else {
                var addHTML = "<img name='workflowImg' id='workflowImg' src='" + imageUrl + "' width='250' >";
                $("#workflowContents").append(addHTML);
            }

            //// get current steps for workflow
            //self.showProgress();
            self.workflowTask.getCurrentSteps(jobId,
                function (steps) {
                    var currentStep = steps[0];
                    self.currentStep = currentStep;      		// current step
                    self.checkCanMarkStepAsDone(currentStep);	// check if step can be marked as done
                    self.checkCanRunStep(currentStep);			// check if step can be run
                    self.hideProgress();
                },
                function (error) {
                    showError("Workflow Error", error);
                    self.hideProgress();
                }
            );

            // show div element
            $("#workflowContents").show();
        },

        executeStep: function () {
            var self = lang.hitch(this);
            self.clearMessage();
            self.hideWorkflow();
            self.showProgress();

            var jobId = self.currentJob.id;
            var stepIds = [self.currentStep.id];
            self.workflowTask.executeSteps(jobId, stepIds, self.currentJob.assignedTo, false,
                function (data) {
                    // check for any execution errors
                    if (data != null && data.length > 0) {
                        var result = data[0];
                        if (result.threwError) {
                            self.showError("Workflow Error", result.errorDescription);
                        }
                    }
                    // reload workflow
                    self.loadWorkflow();
                },
                function (error) {
                    self.hideProgress();
                    self.showError("Workflow Error", error);
                }
            );
        },

        //
        // mark step as complete
        //
        markAsComplete: function () {
            var self = lang.hitch(this);
            self.clearMessage();
            self.hideWorkflow();
            self.showProgress();

            var stepIds = [self.currentStep.id];
            self.workflowTask.markStepsAsDone(self.currentJob.id, stepIds, self.currentJob.assignedTo,
                function (data) {
                    self.loadWorkflow();
                },
                function (error) {
                    self.hideProgress();
                    self.showError("Workflow Error", error);
                }
            );
        },

        checkCanRunStep: function (step) {
            var self = lang.hitch(this);
            self.canRunStep = false;

            //Use the workflowTask to check if a step can be run or not
            self.workflowTask.canRunStep(self.currentJob.id, step.id, self.user,
                function (stepStatus) {
                    if (stepStatus == Enum.StepRunnableStatus.CAN_RUN) {
                        self.canRunStep = true;
                    }
                    dom.byId("executeStep").disabled = !(self.canRunStep);
                    self.showWorkflow();
                },
                function (error) {
                    self.showError("Workflow Error", error);
                    dom.byId("executeStep").disabled = true;
                    self.showWorkflow();
                }
            );
        },

        //
        //Check if step can be marked as done
        //
        checkCanMarkStepAsDone: function (step) {
            this.canMarkStepAsDone = (step.canSkip || step.hasBeenExecuted
            || (step.stepType.executionType == Enum.StepExecutionType.PROCEDURAL));

            // disable the mark as done button as needed
            dom.byId("markAsComplete").disabled = !(this.canMarkStepAsDone);
        }

    });

});


